#Сервис работы с торговыми поручениями

##Статусная модель торговых поручений

![Диаграмма статусов торговых поручений](/investAPI/img/order_status_diagram.png "Диаграмма статусов торговых поручений")

##Метод выставления торговых поручений

Одной из главных функций торгового робота, безусловно, является выставление на бирже торговых поручений. 
Для решения этой задачи можно использовать unary-метод [postOrder](/investAPI/orders#postorder).

Unary-метод [postOrder](/investAPI/orders#postorder) позволяет выставлять все 
типы торговых поручений (рыночные, лимитные). 
Подробнее о торговых поручениях, их видах и особенностях исполнения на биржах можно почитать в статье: 
[Работа с торговыми поручениями](/investAPI/faq_orders/).

**Важно!** Для исключения дублирования торговых поручений в процессе работы используется параметр 
*order_id*, который требуется сгенерировать любым удобным способом перед вызовом метода. Если
сервис получит несколько запросов с одинаковым *order_id*, то на биржу выставится только одно торговое
поручение. Все последующие запросы, содержащие существующий *order_id*, будут возвращать статус этого
торгового поручения. 

<a name="coupon"></a>
При выполнении **операций с облигациями** следует также учитывать [накопленный купонный доход](/investAPI/glossary#coupon).
Размер НКД можно узнать при помощи параметра *aci_value* методов получения информации по облигациям или метода
выставления торгового поручения. Обратите внимание, что в параметре *aci_value* возвращается размер НКД в
валюте расчётов за 1 лот. **Т.е. при покупке облигаций к стоимости сделки будет добавлено произведение НКД на
количество лотов в сделке (*aci_value*\**quantity*), при продаже на это произведение сумма сделки будет уменьшена.**

##Получение списка активных торговых поручений по счёту

Для того, чтобы торговому роботу более эффективно управлять торговыми поручениями, ему нужно иметь 
возможность получать список активных на данный момент заявок. Для решения этой задачи используется метод
[getOrders](/investAPI/orders#getorders). Обратите внимание, что данный метод 
возвращает только активные торговые поручения, т.е. после исполнения заявка пропадает из возвращаемого 
списка. 

##Получение статуса торгового поручения

Несмотря на то, что статус исполнения поданного торгового поручения можно получить повторным вызовом 
метода выставления (с тем же параметром *order_id*), рекомендуется использовать для этих целей метод 
[getOrderState](/investAPI/orders#getorderstate). Данный метод возвращает, в том числе, стадии 
выполнения заявки (массив *stages*).

**Важно!** Метод получения статуса торгового поручения не предусмотрен для получения глубокой 
истории и может не возвращать информацию по поручениям "старше" одних суток.

##Отмена торгового поручения

Далеко не все торговые поручения, выставляемые на торговую площадку, могут и должны быть исполнено. 
Ситуация на рынке меняется динамично, поэтому торговому роботу необходима возможность отменять
выставленные заявки. Для реализации этой функциональности используется метод [cancelOrder](/investAPI/orders#cancelorder).

##Stream исполнения поручений пользователя

TINKOFF INVEST API предоставляет stream с трансляцией исполнения сделок. В данный стрим попадают все
совершённые сделки по всем счетам пользователя. 

Для сохранения стабильного подключения при отсутствии данных в stream-соединении сервером периодически
отправляется ping-пакет. Клиенту реагировать на него нет необходимости.


##Изменение выставленных торговых поручений

Для изменения уже выставленных поручений в TINKOFF INVEST API добавлен метод [replaceOrder](/investAPI/orders#replaceorder).

Данный метод позволяет изменить существующую выставленную заявку, путем ее отмены и выставления новой заявки с измененными параметрами.

Для использования данного метода необходимо использовать идентификатор заявки на бирже, полученный при выставлении заявки с помощью Unary-метода [postOrder](/investAPI/orders#postorder).

Во время использования метода, могут произойти различные события на разных этапах исполнения. 
Так если ошибка произойдет из-за невозможности отмены поручения, то вернется ошибка с кодом 30059, и описание причины в message.
В случаях если после отмены поручения невозможно выставить новое поручение, то вернется ошибка метода [postOrder](/investAPI/orders#postorder) с соответствующим кодом и описанием.


###TradesStream - стрим совершенных сделок пользователя

В TINKOFF INVEST API представлен gRPC server-side [TradesStream](https://tinkoff.github.io/investAPI/orders/#tradesstream) получения сделок с биржи.
Стрим предназначен для получения событий по поручениям пользователя, по факту их исполнения.
Использование TradesStream поможет в быстром получении информации об исполнении поручения, и выполненных сделках в рамках поручения, с отображением номера счета на котором выполнилось поручение.

Для работы со стрим-соединениями также существуют ограничения, согласно [лимитной политике](/investAPI/limits)



