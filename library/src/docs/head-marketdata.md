#Сервис котировок

Данный сервис предназначен для получения различной (в т.ч. исторической) биржевой информации. 
Существует два варианта взаимодействия с сервисом котировок: 

1. **Unary-методы** — данный вариант следует использовать в случаях, когда не требуется оперативность получения
информации или для загрузки исторических данных. Существует ограничение на количество запросов в минуту,
подробнее: [Лимитная политика](/investAPI/limits).
2. **Bidirectional-stream** — используется для получения биржевой информации в реальном времени с минимально 
возможными задержками. Для работы со стрим-соединениями также существуют ограничения, согласно [лимитной политике](/investAPI/limits).

**Важно!** В сервисе TINKOFF INVEST API для отображения цен облигаций и фьючерсов используются пункты.
Для облигаций один пункт равен одному проценту номинала облигации.
Для расчёта реальной стоимости фьючерса можно воспользоваться формулой:

> **price** / **min_price_increment** * **min_price_increment_amount**

##Получение исторических свечей

В процессе разработки торгового робота требуется анализировать различную историческую информацию. Например,
свечи. Для получения исторических свечей по инструменту можно использовать метод [getCandles](/investAPI/marketdata#getcandles).

Обратите внимание, что максимально допустимый период получения свечей за один запрос — 1 календарный год. 
Получение данных за более длинный период возможно поочередным вызовом метода. 

##Получение последних цен

В процессе работы алгоритма торговли может потребоваться получение цены последней сделки по инструменту или
инструментам. Для реализации данной потребности следует использовать метод [getLastPrices](/investAPI/marketdata#getlastprices).
Используя данный метод вы можете получить последние цены всех доступных для торговли инструментов — для 
этого требуется передать пустой массив *instruments*.

Если для реализации алгоритма требуется оперативно получать информацию о цене последней сделки, то команда
TINKOFF INVEST API рекомендует использовать [подписку на поток обезличенных сделок](/investAPI/marketdata#subscribetradesrequest) 
в рамках [stream-соединения сервиса](/investAPI/marketdata#marketdatastream).

##Получение текущего стакана

Биржевой стакан — один из ключевых показателей торгового инструмента. Стакан содержит заявки пользователей
на покупку или продажу определённого инструмента (подробнее: [Биржевой стакан](https://www.tinkoff.ru/invest/account/help/trade-on-bs/bids/#q13)).
Для получения стакана можно использовать метод [getOrderbook](/investAPI/marketdata#getorderbook). 

Для высоколиквидных инструментов на бирже стакан может изменяться несколько раз за секунду, поэтому 
использование unary-метода не всегда будет удобным. Поэтому рекомендуется использовать 
[подписку на стаканы](/investAPI/marketdata#subscribeorderbookrequest) в рамках 
[stream-соединения сервиса](/investAPI/marketdata#marketdatastream).

<a name="stream"></a>

##Bidirectional-stream получения биржевой информации

В рамках stream-соединения можно получать поток интересующих данных. В рамках одного соединения пользователь
может подписаться на получение:

1. стаканов (с глубиной 1, 10, 20, 30, 40 или 50); 

2. свечей; 

3. потока обезличенных сделок; 

4. статуса торговли инструментов;

5. последних цен;

6. информации о своих подписках.

**Важно.** В рамках одного запроса можно управлять подпиской только одного типа данных. Т.е. чтобы подписаться на свечи 
и стаканы требуется отправить два запроса [marketdataRequest](/investAPI/marketdata#marketdatarequest), 
содержащие информацию об изменении статуса подписки на свечи и стаканы соответственно. 

Для сохранения стабильного подключения при отсутствии данных в stream-соединении сервером периодически
отправляется ping-пакет. Клиенту реагировать на него нет необходимости.

Обратите внимание, что максимальное количество подписок на одно соединение ограничено [лимитной политикой](/investAPI/limits/) 
TINKOFF INVEST API. Однако, это ограничение **не распространяется** на подписку *info* (получение торгового
статуса инструмента).

###Особенности трансляции свечей

Свечи в рамках bidirectional-stream собираются "на лету" из ленты обезличенных сделок. Свечи отправляются не чаще
одного раза в 300мс + свеча закрытия периода сбора. Однако, бывают ситуации, что сделки с биржи фактически
доходят уже после окончания периода сбора свечи, в таком случае в стрим отправляется ещё одна (или более) 
"корректирующая" свеча. 

###Получения исторических рыночных данных по инструментам в виде годового архива

Используя [метод](/investAPI/get_history) можно получить zip-архив исторических минутных свечей за год.

Обратите внимание, что максимально допустимый период получения свечей за один запрос — 1 календарный год.
Получение данных за более длинный период возможно поочередным вызовом метода. 

Так же в [методе](/investAPI/get_history) для удобства представлен скрипт получения zip-архивов по списку инструментов за все доступные года.
Скрипт выполняет поочередный вызов метода по всем доступным годам.

###Лимиты на количество запросов на подписку

Для всех типов подписок в [методе](/investAPI/marketdata/#marketdatastream) установлены ограничения максимального количества запросов на подписку. 
Если количество запросов за минуту превысит 100, то для всех элементов будет установлен статус [SUBSCRIPTION_STATUS_TOO_MANY_REQUESTS](/investAPI/marketdata/#subscriptionstatus).

###Получение информации о своих подписках

Для получения информации о своих подписках в методе [marketDataStream](/investAPI/marketdata/#marketdatastream) предусмотрен специальный запрос на получение информации о своих подписках - `get_my_subscriptions`.


